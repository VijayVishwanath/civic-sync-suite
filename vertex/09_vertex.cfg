# Vertex AI Configuration (pseudo-Terraform/CLI)

# Feature Store setup
resource "google_vertex_ai_featurestore" "municipal_fs" {
  name     = "municipal-feature-store"
  region   = "asia-south1"
  
  online_serving_config {
    fixed_node_count = 1
  }
  
  labels = {
    environment = "production"
    project     = "municipal-ai"
  }
}

resource "google_vertex_ai_featurestore_entitytype" "ticket" {
  name         = "ticket"
  featurestore = google_vertex_ai_featurestore.municipal_fs.id
  
  monitoring_config {
    snapshot_analysis {
      disabled = false
    }
  }
}

# Feature definitions
features = [
  "ward_tickets_7d:INT64",
  "ward_escalation_rate_7d:DOUBLE",
  "ward_avg_response_time_7d:DOUBLE",
  "category_escalation_rate_30d:DOUBLE",
  "citizen_tickets_30d:INT64",
  "citizen_escalations:INT64",
  "hour_of_day:INT64",
  "day_of_week:INT64",
  "is_weekend:BOOL",
  "photo_count:INT64",
  "sentiment_score:DOUBLE"
]

# Training pipeline
gcloud ai custom-jobs create \
  --region=asia-south1 \
  --display-name=ticket-priority-training-v1 \
  --worker-pool-spec=machine-type=n1-standard-4,replica-count=1,container-image-uri=gcr.io/PROJECT_ID/ml-trainer:latest \
  --args=^:^--training-data=gs://PROJECT_ID-ml-data/features/training_*.csv:--model-output=gs://PROJECT_ID-models/priority-model-v1:--target=priority_score:--algorithm=xgboost

# Model parameters
model_config = {
  algorithm: "xgboost"
  objective: "reg:squarederror"
  max_depth: 8
  learning_rate: 0.1
  n_estimators: 200
  subsample: 0.8
  colsample_bytree: 0.8
  eval_metric: ["rmse", "auc"]
  early_stopping_rounds: 20
}

# Model upload to registry
gcloud ai models upload \
  --region=asia-south1 \
  --display-name=ticket-priority-v1 \
  --artifact-uri=gs://PROJECT_ID-models/priority-model-v1 \
  --container-image-uri=gcr.io/PROJECT_ID/prediction-server:latest \
  --container-health-route=/health \
  --container-predict-route=/predict

# Endpoint deployment
gcloud ai endpoints create \
  --region=asia-south1 \
  --display-name=ticket-priority-endpoint

gcloud ai endpoints deploy-model ENDPOINT_ID \
  --region=asia-south1 \
  --model=projects/PROJECT_ID/locations/asia-south1/models/MODEL_ID \
  --display-name=ticket-priority-v1 \
  --machine-type=n1-standard-2 \
  --min-replica-count=1 \
  --max-replica-count=5 \
  --traffic-split=0=100

# Feature ingestion from BigQuery
gcloud ai feature-store entity-types import-feature-values \
  --entity-type=ticket \
  --featurestore=municipal-feature-store \
  --region=asia-south1 \
  --source-bigquery-uri=bq://PROJECT_ID.municipal_data.ward_aggregates_7d \
  --entity-id-field=ticket_id \
  --feature-time-field=feature_date
